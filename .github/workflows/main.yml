name: Auto-assign and notify on new issues

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      process_existing:
        description: 'Process all open issues without assignees'
        required: false
        default: 'true'
        type: boolean

# Define team members for round-robin assignment
# Set TEAM_MEMBERS in: Settings â†’ Secrets and variables â†’ Actions â†’ Variables
env:
  TEAM_MEMBERS: ${{ vars.TEAM_MEMBERS }}

jobs:
  # Job for new issues (triggered automatically)
  assign-new-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign issue using round-robin
        uses: actions/github-script@v7
        env:
          TEAM_MEMBERS: ${{ env.TEAM_MEMBERS }}
        with:
          script: |
            const teamMembers = process.env.TEAM_MEMBERS.split(',').map(m => m.trim());
            const issueNumber = context.issue.number;
            
            // Round-robin: use issue number to determine assignee
            const assigneeIndex = issueNumber % teamMembers.length;
            const assignee = teamMembers[assigneeIndex];
            
            console.log(`Assigning issue #${issueNumber} to ${assignee} (index ${assigneeIndex} of ${teamMembers.length})`);
            
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              assignees: [assignee]
            });
            
            // Store assignee for next step
            core.exportVariable('ASSIGNED_TO', assignee);

      - name: Add notification comment
        uses: actions/github-script@v7
        env:
          ASSIGNED_TO: ${{ env.ASSIGNED_TO }}
        with:
          script: |
            const issue = context.payload.issue;
            const assignee = process.env.ASSIGNED_TO;
            const comment = `ðŸ‘‹ @${assignee} - A new issue has been automatically assigned to you!

            **Issue:** #${issue.number}
            **Title:** ${issue.title}
            **Author:** @${issue.user.login}
            **Created:** ${new Date(issue.created_at).toLocaleString()}
            
            _(Assigned via round-robin rotation)_

            Please review and triage this issue.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Add triage label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['triage']
            });

  # Job for existing issues (triggered manually via workflow_dispatch)
  process-existing-issues:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Process all unassigned open issues with round-robin
        uses: actions/github-script@v7
        env:
          TEAM_MEMBERS: ${{ env.TEAM_MEMBERS }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const teamMembers = process.env.TEAM_MEMBERS.split(',').map(m => m.trim());
            
            // Get all open issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });
            
            // Filter to unassigned issues only (exclude PRs)
            const unassignedIssues = issues.filter(issue => 
              !issue.pull_request && 
              (!issue.assignees || issue.assignees.length === 0)
            );
            
            console.log(`Found ${unassignedIssues.length} unassigned open issues`);
            
            let assignmentIndex = 0;
            
            for (const issue of unassignedIssues) {
              // Round-robin assignment
              const assignee = teamMembers[assignmentIndex % teamMembers.length];
              assignmentIndex++;
              
              console.log(`Assigning issue #${issue.number} to ${assignee}`);
              
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issue.number,
                assignees: [assignee]
              });
              
              // Add comment
              const comment = `ðŸ‘‹ @${assignee} - This existing issue has been automatically assigned to you!

              **Issue:** #${issue.number}
              **Title:** ${issue.title}
              **Author:** @${issue.user.login}
              **Created:** ${new Date(issue.created_at).toLocaleString()}              
              _(Assigned via round-robin rotation)_
              Please review and triage this issue.`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: comment
              });
              
              // Add triage label
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issue.number,
                labels: ['triage']
              });
              
              console.log(`Successfully processed issue #${issue.number}`);
            }
