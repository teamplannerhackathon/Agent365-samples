name: Auto-assign and notify on new issues

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      process_existing:
        description: 'Process all open issues without assignees'
        required: false
        default: 'true'
        type: boolean

jobs:
  # Job for new issues (triggered automatically)
  assign-new-issue:
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Assign issue to teamplannerhackathon
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: ['teamplannerhackathon']
            });

      - name: Add notification comment
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const comment = `ðŸ‘‹ @teamplannerhackathon - A new issue has been automatically assigned to you!

            **Issue:** #${issue.number}
            **Title:** ${issue.title}
            **Author:** @${issue.user.login}
            **Created:** ${new Date(issue.created_at).toLocaleString()}

            Please review and triage this issue.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Add triage label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['triage']
            });

  # Job for existing issues (triggered manually via workflow_dispatch)
  process-existing-issues:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Process all unassigned open issues
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // Get all open issues without assignees
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: 'open',
              per_page: 100
            });
            
            console.log(`Found ${issues.length} open issues`);
            
            for (const issue of issues) {
              // Skip pull requests (they show up in issues API too)
              if (issue.pull_request) continue;
              
              // Skip if already assigned
              if (issue.assignees && issue.assignees.length > 0) {
                console.log(`Issue #${issue.number} already assigned, skipping`);
                continue;
              }
              
              console.log(`Processing issue #${issue.number}: ${issue.title}`);
              
              // Assign to teamplannerhackathon
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issue.number,
                assignees: ['teamplannerhackathon']
              });
              
              // Add comment
              const comment = `ðŸ‘‹ @teamplannerhackathon - This existing issue has been automatically assigned to you!

              **Issue:** #${issue.number}
              **Title:** ${issue.title}
              **Author:** @${issue.user.login}
              **Created:** ${new Date(issue.created_at).toLocaleString()}

              Please review and triage this issue.`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body: comment
              });
              
              // Add triage label
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issue.number,
                labels: ['triage']
              });
              
              console.log(`Successfully processed issue #${issue.number}`);
            }
